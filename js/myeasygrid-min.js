/*
 * MyEasygrid for jQuery -  v1.8.3
 *
 * Copyright (c) 2013 Jiabei Li
 *
 */
(function($){Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in t)(new RegExp("("+n+")")).test(e)&&(e=e.replace(RegExp.$1,RegExp.$1.length==1?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e},$.addGrid=function(g,st){st=$.extend({url:"",method:"POST",pageNo:1,pageSize:5,rowid:"id",rowidType:"checkbox",number:!1,conditions:[],buttons:[],batchButton:[],result:[],onPageChange:null,onRowDbclick:null,onFinish:null},st);var t={init:function(){var e=$('<table class="table table-hover">'),n=$("<colgroup>").append($('<col width="4%"/>')),r=$("<thead>"),i=$("<tfoot>"),s=$("<tbody></tbody>"),o=$('<input class="checkall" type="'+st.rowidType+'"/>'),u=$("<tr>").append($("<th>").html(o));st.number==1&&(n.append('<col width="4%" />'),u.prepend("<th>编号</th>")),$.each(st.result,function(e,t){var r=$('<col width="'+t.weight+'" />');n.append(r);var i=$('<th align="'+t.align+'">'+t.title+"</th>");u.append(i)}),r.html(u);var a=st.number==1?st.result.length+2:st.result.length+1,f='<td colspan="'+a+'"><section class="pagination-section"><div class="pagination-left"></div><div class="pagination"></div></section></td>';i.html($("<tr></tr>").html(f)),e.append(n).append(r).append(i).append(s),$(g).html(e),t.tbody=s,t.pagination=f,t.url=st.url,t.pageNo=st.pageNo,t.onPageChange=st.onPageChange,t.onRowDbclick=st.onRowDbclick,t.onFinish=st.onFinish,t.ckall=o,o.click(function(){o.prop("checked")?$('input[name="ck_box"]',g).each(function(){this.checked=!0}):$('input[name="ck_box"]',g).each(function(){this.checked=!1})}),$.each(st.buttons,function(e,n){$("#"+n.id).click(function(){return n.action!=null&&n.action!=""?t.url=n.action:t.url=st.url,t.getcondition(),t.page_change(1),!1})}),$.each(st.batchButton,function(e,t){e>0&&$(".pagination-left",g).append("&nbsp;&nbsp;");var n=$(t.tag);t.tag&&n.bind("click",t.tagClick),$(".pagination-left",g).append(n)})},getcondition:function(){var e="pageSize="+st.pageSize;$.each(st.conditions,function(t,n){n.type=="checkbox"?$("input[name="+n.inputId+"]:checked").each(function(){e=e+"&"+n.postName+"="+$(this).val()}):e=e+"&"+n.postName+"="+$("#"+n.inputId).val()}),t.condition=e},_dateFormat:function(e,t,n){return e==null||e==" "?n:(new Date(e)).format(t)},_conditionpost:function(e){$.ajax({type:st.method,url:t.url,dataType:st.dataType,data:t.condition+"&pageNo="+e,success:function(e){t.add_data(e)}}).fail(function(e,t){alert("Request failed: "+t)})},page_change:function(e){if(t.onPageChange){var n={pageNo:t.pageNo,clickPageNo:e};$(t.onPageChange(n))}if(t.url==null||t.url=="")return!1;t._conditionpost(e)},_click_row:function(){$("tbody tr",g).dblclick(function(){if(t.onRowDbclick){var e=$('input[name="ck_box"]',this).val();$(t.onRowDbclick(e))}})},_generatePg:function(e,t){return e<1?'<li class="active"><span>'+t+"</span></li>":'<li><a href="javascript:void(0);" tabindex='+e+">"+t+"</a></li>"},add_data:function(data){$("#checkall").removeAttr("checked"),t.tbody.html("");var _pageNo=0,_totalPages=0,pages="<ul>",row_count=0;$.each(data.result,function(key,val){var srow=$("<tr></tr>");st.number==1&&srow.append('<th style="text-align:center;">'+(row_count+1)+"</th>");var ckbox=$('<input name="ck_box" type="'+st.rowidType+'" value="'+val[st.rowid]+'"/>');srow.append($("<td>").html(ckbox)),$.each(st.result,function(index,_val){var value=$("<td>");if(_val.operation)for(var i=0;i<_val.operation.length;i++){if(_val.operation[i].condition&&val[_val.operation[i].condition.valueName]!=_val.operation[i].condition.need)continue;i>0&&value.append('<span style="margin:0 3px;">/</span>');var tag=_val.operation[i].tag,data="{";for(var j=0;j<_val.operation[i].parameters.length;j++){var para=_val.operation[i].parameters[j];j>0&&(data+=",");var v=val[para]==null?"":val[para];data=data+para+':"'+v+'"',tag=tag.replace("{"+j+"}",v)}data+="}";if(_val.operation[i].tagClick){var btn=$(tag);btn.bind("click",eval("("+data+")"),_val.operation[i].tagClick),value.append(btn)}else value.append(tag)}else{var keys=_val.valueName.split(".");v=val[keys[0]]==null?" ":val[keys[0]];for(var i=1;i<keys.length;i++){v=v[keys[i]];if(v==null){v=" ";break}}typeof v=="object"&&(v=" "),_val.format&&(v=t._dateFormat(v,_val.format," ")),value.html(v)}srow.append(value)}),t.tbody.append(srow),row_count++}),_pageNo=data.pageNo,_totalPages=data.totalPages;for(;row_count<st.pageSize;row_count++)t.tbody.append('<tr><td colspan="'+(st.result.length+2)+'">'+"&nbsp;"+"</td></tr>");_pageNo>1&&_totalPages>1&&(pages+=t._generatePg(1,"首页"),pages+=t._generatePg(_pageNo-1,"上一页"));for(var i=1;i<=_totalPages;i++)i!=_pageNo&&_pageNo-i<5&&i-_pageNo<5?pages+=t._generatePg(i,i):i==_pageNo&&(pages+=t._generatePg(0,i));_pageNo<_totalPages&&_totalPages>1&&(pages+=t._generatePg(_pageNo+1,"下一页"),pages+=t._generatePg(_totalPages,"尾页")),pages=pages+"<li>&nbsp;&nbsp;&nbsp;共<b>"+data.records+"</b>条，<b>"+_totalPages+'</b>页&nbsp;<input type="text" class="skip" /></li>',pages+='<span href="javascript:void(0);" class="skipbtn">确定</span>',pages+="</ul>",$(".pagination",g).html(pages),$(".skipbtn",g).click(function(){var e=$(".skip",g).val();isNaN(e)||(_totalPages<e?t.page_change(_totalPages):e<1?t.page_change(1):t.page_change(e))}),$(".pagination a",g).click(function(){t.page_change($(this).attr("tabindex"))}),t.ckall[0].checked&&(t.ckall[0].checked=!1),t.onFinish&&$(t.onFinish(data)),t._click_row()}};t.init(),g.t=t,g.st=st,t.getcondition(),t.page_change(1)};var docloaded=!1;$(document).ready(function(){docloaded=!0}),$.fn.myeasygrid=function(e){return this.each(function(){if(!docloaded){var t=this;$(document).ready(function(){$.addGrid(t,e)})}else $.addGrid(this,e)})},$.fn.myeasyAddData=function(e){return this.each(function(){this.t&&this.t.add_data(e)})},$.fn.myeasyOptions=function(e){return this.each(function(){this.t&&($.extend(this.st,e),this.t.init())})},$.fn.myeasyPageChange=function(e){return this.each(function(){this.t&&this.t.page_change(e)})},$.fn.myeasyGetCondition=function(){var e;return this.each(function(){this.t&&(e=this.t.condition)}),e},$.fn.myeasyGetCheckValue=function(){var e=[];return $('input[name="ck_box"]:checked',this).each(function(){e.push($(this).val())}),e}})(jQuery)